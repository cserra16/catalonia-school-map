<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://maps.googleapis.com 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' https://maps.gstatic.com https://maps.googleapis.com data:; connect-src 'self' https://maps.googleapis.com; font-src 'self' https://fonts.gstatic.com; frame-src 'self';">
    <title>Centros Educativos de Cataluña</title>
    <!-- Configuración -->
    <script src="js/config.js"></script>
    
    <!-- Google Maps API -->
    <script>
        // Cargar Google Maps API dinámicamente con la clave de configuración
        function loadGoogleMaps() {
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${CONFIG.GOOGLE_MAPS_API_KEY}&callback=onGoogleMapsApiReady`;
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        }
        
        // Llamar a la función cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', loadGoogleMaps);
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .sidebar {
            width: 350px;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            overflow-y: auto;
            z-index: 1000;
        }

        .sidebar-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
        }

        .sidebar-header h1 {
            font-size: 1.4em;
            margin-bottom: 5px;
        }

        .sidebar-header p {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .filters-section {
            padding: 20px;
        }

        .filter-group {
            margin-bottom: 25px;
        }

        .filter-group h3 {
            font-size: 1em;
            color: #333;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .filter-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .filter-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            accent-color: #667eea;
        }

        .checkbox-item label {
            font-size: 14px;
            color: #555;
            cursor: pointer;
        }

        .results-info {
            background: #f8f9fa;
            padding: 15px 20px;
            border-top: 1px solid #e1e5e9;
            font-size: 14px;
            color: #666;
        }

        .clear-filters {
            width: 100%;
            padding: 10px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 15px;
            transition: background-color 0.3s ease;
        }

        .clear-filters:hover {
            background: #c82333;
        }

        .loading-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            text-align: center;
            z-index: 1000;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 40vh;
                order: 2;
            }
            
            .map-container {
                height: 60vh;
                order: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="map-container">
            <div id="map">
                <div class="loading-message">
                    Carregant mapa...
                </div>
            </div>
        </div>
        
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>Centres Educatius</h1>
                <p>Catalunya</p>
            </div>
            
            <div class="filters-section">
                <div class="filter-group">
                    <h3>Cerca per nom</h3>
                    <input type="text" id="nameFilter" class="filter-input" placeholder="Nom del centre...">
                </div>
                
                <div class="filter-group">
                    <h3>Codi postal</h3>
                    <input type="text" id="postalCodeFilter" class="filter-input" placeholder="08000">
                </div>
                
                <div class="filter-group">
                    <h3>Municipi</h3>
                    <input type="text" id="municipalityFilter" class="filter-input" placeholder="Municipi...">
                </div>
                
                <div class="filter-group">
                    <h3>Titularitat</h3>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="public" checked>
                            <label for="public">Públic</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="concerted" checked>
                            <label for="concerted">Concertat</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="private" checked>
                            <label for="private">Privat</label>
                        </div>
                    </div>
                </div>
                
                <div class="filter-group">
                    <h3>Tipus d'estudis</h3>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="infantil" checked>
                            <label for="infantil">Educació Infantil</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="primaria" checked>
                            <label for="primaria">Educació Primària</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="secundaria" checked>
                            <label for="secundaria">Educació Secundària</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="batxillerat" checked>
                            <label for="batxillerat">Batxillerat</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="fp" checked>
                            <label for="fp">Formació Professional</label>
                        </div>
                    </div>
                </div>
                
                <button class="clear-filters" onclick="clearAllFilters()">
                    Esborrar filtres
                </button>
            </div>
            
            <div class="results-info" id="resultsInfo">
                Carregant centres educatius...
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let schoolsData = [];
        let map; // Will hold the Google Map instance
        let markers = []; // Will hold Google Maps marker instances
        let currentInfoWindow = null;

        // Simple HTML sanitization function
        function sanitizeHTML(text) {
            if (text === null || typeof text === 'undefined') {
                return '';
            }
            const textStr = String(text); // Ensure it's a string
            return textStr.replace(/[&<>"']/g, function (match) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                }[match];
            });
        }

        let schoolDataReady = false;
        let googleApiReady = false;

        // 1. Entry point: Load CSV data when DOM is ready
        document.addEventListener('DOMContentLoaded', loadCSVData);

        // 2. Google Maps API callback
        function onGoogleMapsApiReady() {
            console.log("Google Maps API script has loaded.");
            googleApiReady = true;
            tryMapInitialization();
        }

        // 3. Load CSV Data function
        async function loadCSVData() {
            console.log("Attempting to load CSV data...");
            document.getElementById('resultsInfo').textContent = 'Carregant dades...';
            try {
                const response = await fetch('csv/centres-educatius_utf8.csv');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const buffer = await response.arrayBuffer();
                const decoder = new TextDecoder('utf-8');
                const csvText = decoder.decode(buffer);
                const lines = csvText.replace(/\r\n?/g, '\n').split('\n');
                const headers = lines[0].split(';');
                
                const loadedSchools = []; // Temporary array for this load
                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;
                    const values = lines[i].split(';');
                    if (values.length < headers.length) continue;
                    
                    const geoX = parseFloat(values[21]?.replace(',', '.')) || 0;
                    const geoY = parseFloat(values[22]?.replace(',', '.')) || 0;
                    if (geoX === 0 || geoY === 0) continue;
                    
                    const school = {
                        code: values[0] || '',
                        name: values[1] || 'Sense nom',
                        nature: values[3] || 'Desconegut',
                        address: values[6] || 'Adreça no disponible',
                        postalCode: values[7] || '',
                        phone: values[8] || '',
                        municipality: values[14] || 'Municipi desconegut',
                        lat: geoY, lng: geoX, email: values[23] || '', studies: []
                    };
                    
                    // Construir array de estudios basado en las columnas específicas del CSV
                    const studyColumns = {
                        'EINF1C': 25, 'EINF2C': 26, 'EPRI': 27, 'ESO': 28, 'BATX': 29,
                        'CFPM': 31, 'CFPS': 34
                    };
                    
                    for (const [studyType, columnIndex] of Object.entries(studyColumns)) {
                        if (values[columnIndex] && values[columnIndex].trim() !== '') {
                            school.studies.push(studyType);
                        }
                    }
                    
                    loadedSchools.push(school);
                }
                schoolsData = loadedSchools; // Assign to global variable
                schoolDataReady = true;
                console.log(`CSV data loaded successfully. ${schoolsData.length} schools processed.`);
                document.getElementById('resultsInfo').textContent = `S'han carregat ${schoolsData.length} centres educatius.`;
                tryMapInitialization();
            } catch (error) {
                console.error('Error carregant les dades:', error);
                document.getElementById('resultsInfo').innerHTML = 
                    'Error carregant les dades. Assegura\'t que el fitxer CSV estigui al mateix directori.';
                schoolDataReady = false; // Explicitly set to false on error
            }
        }

        // 4. Attempt to initialize the map if both API and data are ready
        function tryMapInitialization() {
            console.log(`Trying map initialization: API Ready? ${googleApiReady}, Data Ready? ${schoolDataReady}, Map Exists? ${!!map}`);
            if (googleApiReady && schoolDataReady && !map) {
                console.log("Both API and data are ready. Initializing map...");
                finalizeMapSetup();
            } else if (map) {
                console.log("Map already initialized.");
            } else {
                console.log("Conditions not yet met for map initialization.");
            }
        }

        // 5. Actual Google Map setup and initial filter application
        function finalizeMapSetup() {
            const mapElement = document.getElementById('map');
            
            // Remove loading message
            const loadingMessage = mapElement.querySelector('.loading-message');
            if (loadingMessage) {
                loadingMessage.remove();
            }
            
            // Create Google Map
            map = new google.maps.Map(mapElement, {
                center: { lat: 41.3874, lng: 2.1686 }, // Center on Barcelona
                zoom: 10,
                styles: [
                    {
                        featureType: "poi",
                        elementType: "labels",
                        stylers: [{ visibility: "off" }]
                    }
                ]
            });
            
            // The global 'markers' array is initialized as empty. 
            // filterSchools() will handle clearing and adding markers.

            // Add event listeners for filter controls
            setupFilterEvents();
            
            // Populate markers based on the initial state of the filter checkboxes
            filterSchools();
        }

        function getFilteredSchools() {
            if (!schoolsData || schoolsData.length === 0) {
                console.warn("getFilteredSchools called but schoolsData is empty.");
                return [];
            }

            const nameFilter = document.getElementById('nameFilter').value.toLowerCase();
            const postalCodeFilter = document.getElementById('postalCodeFilter').value;
            const municipalityFilter = document.getElementById('municipalityFilter').value.toLowerCase();
            
            const publicChecked = document.getElementById('public').checked;
            const concertedChecked = document.getElementById('concerted').checked;
            const privateChecked = document.getElementById('private').checked;
            
            const infantilChecked = document.getElementById('infantil').checked;
            const primariaChecked = document.getElementById('primaria').checked;
            const secundariaChecked = document.getElementById('secundaria').checked;
            const batxilleratChecked = document.getElementById('batxillerat').checked;
            const fpChecked = document.getElementById('fp').checked;

            const allNatureFiltersChecked = publicChecked && concertedChecked && privateChecked;
            const noNatureFiltersChecked = !publicChecked && !concertedChecked && !privateChecked;

            const allStudyFiltersChecked = infantilChecked && primariaChecked && secundariaChecked && batxilleratChecked && fpChecked;
            const noStudyFiltersChecked = !infantilChecked && !primariaChecked && !secundariaChecked && !batxilleratChecked && !fpChecked;

            return schoolsData.filter(school => {
                if (nameFilter && !school.name.toLowerCase().includes(nameFilter)) return false;
                if (postalCodeFilter && !school.postalCode.includes(postalCodeFilter)) return false;
                if (municipalityFilter && !school.municipality.toLowerCase().includes(municipalityFilter)) return false;

                // Nature (Titularidad) Filter Logic
                let passNatureFilter = false;
                if (allNatureFiltersChecked) {
                    passNatureFilter = true; // All titularidades checked -> pass
                } else if (noNatureFiltersChecked) {
                    passNatureFilter = false; // No titularidades checked -> fail
                } else {
                    // Specific titularidades checked
                    const isPublic = school.nature.toLowerCase().includes('públic');
                    const isConcerted = school.nature.toLowerCase().includes('concert');
                    const isPrivate = school.nature.toLowerCase().includes('privat');
                    if ((publicChecked && isPublic) || 
                        (concertedChecked && isConcerted) || 
                        (privateChecked && isPrivate)) {
                        passNatureFilter = true;
                    }
                }
                if (!passNatureFilter) return false;

                // Studies Filter Logic
                let passStudiesFilter = false;
                if (allStudyFiltersChecked || noStudyFiltersChecked) {
                    passStudiesFilter = true; // All studies checked or No studies checked -> pass (don't filter by studies)
                } else {
                    // Specific studies checked - school must have at least one of the selected studies
                    const studies = school.studies || [];
                    const hasInfantil = studies.includes('EINF1C') || studies.includes('EINF2C');
                    const hasPrimaria = studies.includes('EPRI');
                    const hasSecundaria = studies.includes('ESO');
                    const hasBatxillerat = studies.includes('BATX');
                    const hasFP = studies.includes('CFPM') || studies.includes('CFPS');
                    
                    // Cambiar lógica: si al menos uno de los filtros seleccionados coincide, pasa
                    if ((infantilChecked && hasInfantil) ||
                        (primariaChecked && hasPrimaria) ||
                        (secundariaChecked && hasSecundaria) ||
                        (batxilleratChecked && hasBatxillerat) ||
                        (fpChecked && hasFP)) {
                        passStudiesFilter = true;
                    }
                }
                if (!passStudiesFilter) return false;

                return true; // Passed all filters
            });
        }

        function updateResultsInfo(count) {
            document.getElementById('resultsInfo').textContent = 
                `Mostrant ${count} centre${count !== 1 ? 's' : ''} educatiu${count !== 1 ? 's' : ''}`;
        }

        function filterSchools() {
            if (!schoolsData || schoolsData.length === 0) {
                console.warn("filterSchools called but schoolsData is empty or not yet loaded.");
                if (map && markers) {
                    markers.forEach(marker => {
                        if (marker instanceof google.maps.Marker) marker.setMap(null);
                    });
                    markers = [];
                }
                updateResultsInfo(0);
                return; 
            }
            const filteredSchools = getFilteredSchools();
            
            // Actualizar marcadores de Google Maps
            if (map && markers) {
                // Eliminar todos los marcadores actuales
                markers.forEach(marker => {
                    if (marker instanceof google.maps.Marker) {
                        marker.setMap(null);
                    }
                });
                
                // Limpiar array de marcadores
                markers = [];
                
                // Crear nuevos marcadores para las escuelas filtradas
                filteredSchools.forEach(school => {
                    const marker = new google.maps.Marker({
                        position: { lat: school.lat, lng: school.lng },
                        map: map,
                        title: school.name,
                        icon: {
                            url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
                            scaledSize: new google.maps.Size(30, 30)
                        }
                    });
                    
                    // Añadir evento de clic para mostrar ventana de información
                    marker.addListener('click', () => {
                        if (currentInfoWindow) {
                            currentInfoWindow.close();
                        }
                        
                        const infoWindow = new google.maps.InfoWindow({
                            content: `
                                <div style="max-width: 250px;">
                                    <h3 style="margin: 0 0 5px 0; font-size: 14px;">${sanitizeHTML(school.name)}</h3>
                                    <p style="margin: 0 0 5px 0; font-size: 12px;">${sanitizeHTML(school.address)}</p>
                                    <p style="margin: 0 0 5px 0; font-size: 12px;">${sanitizeHTML(school.postalCode)} ${sanitizeHTML(school.municipality)}</p>
                                    <p style="margin: 0 0 5px 0; font-size: 12px;">${sanitizeHTML(school.phone)}</p>
                                    <p style="margin: 0; font-size: 12px;">${sanitizeHTML(school.email)}</p>
                                </div>
                            `
                        });
                        
                        infoWindow.open(map, marker);
                        currentInfoWindow = infoWindow;
                    });
                    
                    markers.push(marker);
                });
            }
            
            // Actualizar información de resultados
            updateResultsInfo(filteredSchools.length);
        }

        function clearAllFilters() {
            document.getElementById('nameFilter').value = '';
            document.getElementById('postalCodeFilter').value = '';
            document.getElementById('municipalityFilter').value = '';
            
            // Set default state for nature filters (e.g., all checked or none, depending on desired default)
            document.getElementById('public').checked = true;
            document.getElementById('concerted').checked = true;
            document.getElementById('private').checked = true;
            
            // Set default state for study filters (e.g., all checked or none)
            document.getElementById('infantil').checked = true;
            document.getElementById('primaria').checked = true;
            document.getElementById('secundaria').checked = true;
            document.getElementById('batxillerat').checked = true;
            document.getElementById('fp').checked = true;
            
            filterSchools(); // Update Google Maps markers
        }

        function setupFilterEvents() {
            document.getElementById('nameFilter').addEventListener('input', filterSchools);
            document.getElementById('postalCodeFilter').addEventListener('input', filterSchools);
            document.getElementById('municipalityFilter').addEventListener('input', filterSchools);
            
            document.getElementById('public').addEventListener('change', filterSchools);
            document.getElementById('concerted').addEventListener('change', filterSchools);
            document.getElementById('private').addEventListener('change', filterSchools);
            
            document.getElementById('infantil').addEventListener('change', filterSchools);
            document.getElementById('primaria').addEventListener('change', filterSchools);
            document.getElementById('secundaria').addEventListener('change', filterSchools);
            document.getElementById('batxillerat').addEventListener('change', filterSchools);
            document.getElementById('fp').addEventListener('change', filterSchools);
        }

        // Handle window resize
        // Commenting out resize listener for canvas map to avoid conflicts
        /* window.addEventListener('resize', () => {
            setTimeout(() => {
                const mapElement = document.getElementById('map');
                const canvas = document.getElementById('mapCanvas');
                if (canvas && mapElement) {
                    const rect = mapElement.getBoundingClientRect();
                    canvas.width = rect.width * window.devicePixelRatio;
                    canvas.height = rect.height * window.devicePixelRatio;
                    canvas.style.width = rect.width + 'px';
                    canvas.style.height = rect.height + 'px';
                    
                    window.mapConfig = {
                        width: rect.width,
                        height: rect.height,
                        centerLat: 41.3887902,
                        centerLng: 2.1596534,
                        zoom: 12,
                        minZoom: 10,
                        maxZoom: 18
                    };
                    
                    const ctx = canvas.getContext('2d');
                    ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
                    
                    // updateMarkers(); // Canvas related
                }
            }, 100);
        }); */
    </script>
</body>
</html>